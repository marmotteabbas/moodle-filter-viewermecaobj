define(["filter_viewermecaobj/three"],function(a){parse_3d_file=function(a,b){switch(a.split(".").pop().toLowerCase()){case"stl":return parse_stl_bin(b);case"obj":return parse_obj(b);case"vf":return parse_vf(arrayBufferToString(b));default:return"Unknown file type"}},arrayBufferToString=function(a,b,c){for(var d=new Uint8Array(a),e=d.length,f="",g=0;g<e;g+=65535){var h=65535;g+65535>e&&(h=e-g),f+=String.fromCharCode.apply(null,d.subarray(g,g+h))}return f?b&&b(f):c&&c("buffer was invalid"),f},parse_obj=function(b){function c(b,c){return new a.Vector2(parseFloat(b),parseFloat(c))}var d=arrayBufferToString(b);vector=function(b,c,d){return new a.Vector3(parseFloat(b),parseFloat(c),parseFloat(d))},face3=function(b,c,d,e){return new a.Face3(b,c,d,e)};var e,f=new a.Object3D;parseVertexIndex=function(a){return a=parseInt(a),a>=0?a-1:a+g.length},parseNormalIndex=function(a){return a=parseInt(a),a>=0?a-1:a+h.length},parseUVIndex=function(a){return a=parseInt(a),a>=0?a-1:a+i.length},add_face=function(a,b,c,d){e.faces.push(face3(g[parseVertexIndex(a)]-1,g[parseVertexIndex(b)]-1,g[parseVertexIndex(c)]-1))},add_uvs=function(a,b,c){e.faceVertexUvs[0].push([i[parseUVIndex(a)].clone(),i[parseUVIndex(b)].clone(),i[parseUVIndex(c)].clone()])},handle_face_line=function(a,b,c){void 0===a[3]?(add_face(a[0],a[1],a[2],c),void 0!==b&&b.length>0&&add_uvs(b[0],b[1],b[2])):(void 0!==c&&c.length>0?(add_face(a[0],a[1],a[3],[c[0],c[1],c[3]]),add_face(a[1],a[2],a[3],[c[1],c[2],c[3]])):(add_face(a[0],a[1],a[3]),add_face(a[1],a[2],a[3])),void 0!==b&&b.length>0&&(add_uvs(b[0],b[1],b[3]),add_uvs(b[1],b[2],b[3])))},/^o /gm.test(d)===!1&&(e=new a.Geometry);for(var g=[],h=[],i=[],j=/v( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,k=/vn( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,l=/vt( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,m=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,n=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,o=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,p=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,q=d.split("\n"),r=0;r<q.length;r++){var s=q[r];s=s.trim();var t;0!==s.length&&"#"!==s.charAt(0)&&(null!==(t=j.exec(s))?g.push(e.vertices.push(vector(t[1],t[2],t[3]))):null!==(t=k.exec(s))?h.push(vector(t[1],t[2],t[3])):null!==(t=l.exec(s))?i.push(c(t[1],t[2])):null!==(t=m.exec(s))?handle_face_line([t[1],t[2],t[3],t[4]]):null!==(t=n.exec(s))?handle_face_line([t[2],t[5],t[8],t[11]],[t[3],t[6],t[9],t[12]]):null!==(t=o.exec(s))?handle_face_line([t[2],t[6],t[10],t[14]],[t[3],t[7],t[11],t[15]],[t[4],t[8],t[12],t[16]]):null!==(t=p.exec(s))?handle_face_line([t[2],t[5],t[8],t[11]],[],[t[3],t[6],t[9],t[12]]):/^o /.test(s)?e=new a.Geometry:/^g /.test(s)||/^usemtl /.test(s)||/^mtllib /.test(s)||/^s /.test(s))}for(var u=f.children,r=0,v=u.length;r<v;r++)var e=u[r].geometry;return{vertices:e.vertices,faces:e.faces,colors:!1}},parse_stl_ascii=function(b){try{var c=arrayBufferToString(b),d=[],e=[],f={};c=c.replace(/\r/,"\n"),c=c.replace(/^solid[^\n]*/,""),c=c.replace(/\n/g," "),c=c.replace(/facet normal /g,""),c=c.replace(/outer loop/g,""),c=c.replace(/vertex /g,""),c=c.replace(/endloop/g,""),c=c.replace(/endfacet/g,""),c=c.replace(/endsolid[^\n]*/,""),c=c.replace(/facet/g,""),c=c.replace(/\s+/g," "),c=c.replace(/^\s+/,"");for(var g,h=0,i=c.split(" "),j=[],k=i.length/12-1,l=0;l<k;l++){j=[];for(var m=0;m<3;m++)f1=parseFloat(i[h+3*m+3]),f2=parseFloat(i[h+3*m+4]),f3=parseFloat(i[h+3*m+5]),g=f[[f1,f2,f3]],null==g&&(g=d.length,d.push(new a.Vector3(f1,f2,f3)),f[[f1,f2,f3]]=g),j.push(g);e.push(new a.Face3(j[0],j[1],j[2])),h+=12}return{vertices:d,faces:e,colors:!1}}catch(n){return"Can't parse file"}},parse_stl_bin=function(b){var c,d,e,f,g,h,i,j=[],k=[],l={},m=arrayBufferToString(b.slice(0,80)).toLowerCase().indexOf("color"),n=new DataView(b,0),o=!0;m>-1&&(def_red_color=n.getUint8(m+6,!0),def_green_color=n.getUint8(m+7,!0),def_blue_color=n.getUint8(m+8,!0));var p=80;try{var q=n.getUint32(p,!0)}catch(r){return"Can't parse file"}var s=84+50*q;if(b.byteLength!=s)return parse_stl_ascii(b);try{for(p+=4;q--;)p+=12,d=n.getFloat32(p,!0),e=n.getFloat32(p+4,!0),f=n.getFloat32(p+8,!0),c=l[[d,e,f]],null==c&&(c=j.length,j.push(new a.Vector3(d,e,f)),l[[d,e,f]]=c),g=c,p+=12,d=n.getFloat32(p,!0),e=n.getFloat32(p+4,!0),f=n.getFloat32(p+8,!0),c=l[[d,e,f]],null==c&&(c=j.length,j.push(new a.Vector3(d,e,f)),l[[d,e,f]]=c),h=c,p+=12,d=n.getFloat32(p,!0),e=n.getFloat32(p+4,!0),f=n.getFloat32(p+8,!0),c=l[[d,e,f]],null==c&&(c=j.length,j.push(new a.Vector3(d,e,f)),l[[d,e,f]]=c),i=c,m>-1?(p+=12,face_color=n.getUint16(p,!0),32768==face_color||65535==face_color?(color_red=def_red_color,color_green=def_green_color,color_blue=def_blue_color):(o=!1,color_red=Math.ceil(8.2258*(31&face_color)),color_green=Math.ceil(8.2258*((992&face_color)>>5)),color_blue=Math.ceil(8.2258*((31744&face_color)>>10))),k.push(new a.Face3(g,h,i,1,new a.Color("rgb("+color_red+","+color_green+","+color_blue+")"))),p+=2):(k.push(new a.Face3(g,h,i)),p+=14);return l=null,{vertices:j,faces:k,colors:m>-1&&!o}}catch(r){return"Can't parse file"}},parse_vf=function(b){var c=JSON.parse(b),d=[],e=[];try{var f=c.vertices.length;for(i=0;i<f;i++)d.push(new a.Vector3(c.vertices[i][0],c.vertices[i][1],c.vertices[i][2]));var f=c.faces.length;for(i=0;i<f;i++)e.push(new a.Face3(c.faces[i][0],c.faces[i][1],c.faces[i][2]));return{vertices:d,faces:e,colors:!1}}catch(g){return"Can't parse file"}},geo_to_vf=function(a){var b=[],c=[],d=a.vertices.length;for(i=0;i<d;i++)b.push([a.vertices[i].x,a.vertices[i].y,a.vertices[i].z]);var d=a.faces.length;for(i=0;i<d;i++)c.push([a.faces[i].a,a.faces[i].b,a.faces[i].c]);return{vertices:b,faces:c,colors:!1}}});